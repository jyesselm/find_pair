# JSON Comparison Scripts

## Overview

This directory contains scripts for comparing generated JSON files with legacy JSON files to verify correctness.

## compare_json_files.py

Compares JSON files in `data/json/` (generated by tests) with corresponding files in `data/json_legacy/` (reference files).

### Usage

```bash
# Basic usage - compare all JSON files
python scripts/compare_json_files.py

# With custom tolerance
python scripts/compare_json_files.py --tolerance 0.0001

# With verbose output (shows all errors)
python scripts/compare_json_files.py --verbose

# With custom worker count (processes or threads)
python scripts/compare_json_files.py --threads 8

# Use threading instead of multiprocessing
python scripts/compare_json_files.py --use-threads

# Use multiprocessing (default, better for CPU-bound tasks)
python scripts/compare_json_files.py --use-processes

# Custom directories
python scripts/compare_json_files.py --gen-dir data/json --leg-dir data/json_legacy
```

### Options

- `--tolerance TOL`: Tolerance for floating point comparisons (default: 0.001)
- `--threads N`: Number of workers (processes or threads) for parallel comparison (default: CPU count)
- `--use-processes`: Use multiprocessing instead of threading (default, better for CPU-bound JSON parsing)
- `--use-threads`: Use threading instead of multiprocessing (better for I/O-bound tasks)
- `--verbose`: Print detailed error messages for each file
- `--gen-dir DIR`: Directory containing generated JSON files (default: data/json)
- `--leg-dir DIR`: Directory containing legacy JSON files (default: data/json_legacy)

### Output

The script prints:
- Progress for each file being compared (✓ for match, ✗ for mismatch)
- Summary with total files, passed, and failed counts
- List of failed files with error counts
- Detailed errors if `--verbose` is used

### Exit Code

- 0 if all files match
- 1 if any files have differences

## Workflow

1. **Generate JSON files** by running the integration test:
   ```bash
   cd build
   ./tests/integration/test_json_generation
   ```

2. **Compare generated files** with legacy files:
   ```bash
   python scripts/compare_json_files.py --verbose
   ```

3. **Review differences** and fix any issues in the code.

## Comparison Details

The script compares:
- Top-level fields (pdb_name, pdb_file, etc.)
- Calculations arrays (matching by type)
- All numeric values (with tolerance)
- Arrays and nested objects recursively

### Tolerance

Floating point values are compared with a tolerance (default 0.001). This accounts for:
- Floating point precision differences
- Rounding in serialization
- Minor numerical differences in calculations

### Parallel Processing

The script uses **multiprocessing by default** (better for CPU-bound JSON parsing) to compare multiple files in parallel, significantly speeding up comparison for large numbers of files.

**Multiprocessing vs Threading:**
- **Multiprocessing (default)**: Uses separate processes, bypasses Python's GIL, better for CPU-bound tasks like JSON parsing. Recommended for most cases.
- **Threading**: Uses threads within a single process, better for I/O-bound tasks. Use `--use-threads` if you prefer threading.

The script automatically uses all available CPU cores by default. You can specify a custom number with `--threads N`.

