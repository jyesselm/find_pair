# 3G8T Debug Report

**Last Updated**: 2025-11-28  
**Status**: ✅ Fixed (Perfect Match on 10-PDB Test)  
**Overall Match**: 100%

---

## Summary

| Metric | Before | After | Target |
|--------|--------|-------|--------|
| Missing pairs | 1 | 0 | 0 |
| Extra pairs | 1 | 0 | 0 |
| find_bestpair match | ~98% | 100% | 100% |
| bp_type_id match | Issues | 100% | 100% |

---

## Issues Found (Now Fixed)

### Issue 1: ✅ FIXED - Extra Pair (941, 947)

**Problem**: Modern selected this pair, legacy didn't.

**Root Cause**: Overlap calculation difference
- Legacy: Used `ring_atom[10+i]` = exactly one exocyclic atom per ring atom
- Modern: Used `is_base_atom()` = ALL base atoms (ring + all exocyclic)
- Impact: Modern selected MORE atoms → different polygon → different overlap_area

**Fix Applied**: Updated `calculate_overlap_area()` to:
1. Find ring atoms using RA_LIST
2. For each ring atom, find ONE exocyclic atom (connected atom < 2.0 Å, not a ring atom)
3. Use exactly n atoms (one per ring atom, matching legacy)

**Verification**: 
- 3G8T now shows perfect match (no mismatched pairs)
- Pair (941, 947) no longer selected

---

### Issue 2: ✅ FIXED - Missing Pair (946, 947)

**Problem**: Legacy selected this pair, modern didn't.

**Root Cause**: `bp_type_id = -1` was being converted to `0` for valid pairs

**Analysis**:
- Both pairs are valid (`is_valid = 1`)
- Base quality scores match (8.344808)
- Direction vectors: dir_x=0.676, dir_y=0.767, dir_z=0.840
- Direction vector condition: FALSE (dir_y > 0, dir_z > 0)
- Legacy: `bp_type_id = -1` preserved
- Modern (before fix): `bp_type_id = 0` ❌
- Modern (after fix): `bp_type_id = -1` ✅

**Fix Applied**: 
- Removed conversion of `bp_type_id = -1` to `0` for valid pairs
- File: `src/x3dna/algorithms/base_pair_finder.cpp`

**Before**:
```cpp
if (bp_type_id == -1 && result.is_valid) {
    bp_type_id = 0;  // ❌ WRONG
}
```

**After**:
```cpp
// DO NOT convert -1 to 0 for valid pairs - legacy keeps -1 in some cases
if (!result.is_valid) {
    bp_type_id = 0;
}
```

---

## Fixes Applied

| Date | Fix | File | Impact |
|------|-----|------|--------|
| 2025-11-26 | Overlap calculation fix | base_pair_validator.cpp | Pair (941, 947) no longer extra |
| 2025-11-26 | bp_type_id = -1 preservation | base_pair_finder.cpp | Pair (946, 947) now matches |

---

## Verification Results

After all fixes:
- ✅ No missing pairs
- ✅ No extra pairs
- ✅ All bp_type_id values match legacy
- ✅ All quality scores match legacy
- ✅ Perfect match on 10-PDB test set

---

## Key Learnings

### 1. Overlap Calculation
- Legacy selects exactly one exocyclic atom per ring atom
- Modern must replicate this exactly for overlap area calculation
- Affects which pairs pass validation

### 2. bp_type_id Preservation
- Legacy preserves `bp_type_id = -1` when:
  - Direction vectors don't match condition (dir_x > 0 && dir_y < 0 && dir_z < 0)
  - OR `check_wc_wobble_pair` doesn't classify the pair
- Modern should NOT convert `-1` to `0` for valid pairs

### 3. bp_type_id Values
- `-1`: Valid pair, not classified as wobble or Watson-Crick
- `0`: Invalid pair
- `1`: Wobble pair
- `2`: Watson-Crick pair (quality_score -= 2.0)

---

## Related Documentation

- [100_PERCENT_MATCH_STATUS.md](../100_PERCENT_MATCH_STATUS.md) - Overall status
- [BP_TYPE_ID_BUG_FIX.md](../BP_TYPE_ID_BUG_FIX.md) - Detailed bug fix documentation
- [OVERLAP_CALCULATION.md](../OVERLAP_CALCULATION.md) - Overlap calculation details

---

*Debug report for 3G8T - this PDB now has 100% match!*

